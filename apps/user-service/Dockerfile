###################
#       Deps
###################
FROM node:22-alpine AS deps

WORKDIR /usr/src/workspace

ENV PNPM_HOME="/pnpm"
ENV PNPM_STORE_DIR="/pnpm/store"
RUN corepack enable

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json .npmrc ./
COPY packages/core/package.json packages/core/
COPY apps/user-service/package.json apps/user-service/

RUN --mount=type=cache,id=pnpm-store-node22,target=/pnpm/store,sharing=locked \
    pnpm fetch

###################
#     Builder
###################
FROM deps AS builder

WORKDIR /usr/src/workspace

ENV PNPM_HOME="/pnpm"
ENV PNPM_STORE_DIR="/pnpm/store"
RUN corepack enable

COPY . .

RUN --mount=type=cache,id=pnpm-store-node22,target=/pnpm/store,sharing=locked \
    pnpm install --offline --frozen-lockfile \
 && pnpm --filter '{packages/core}' \
         --filter '{apps/user-service}' \
         build

RUN pnpm deploy --filter '{apps/user-service}' --prod /app

###################
#   Application
###################
FROM node:22-alpine

USER 1000:1000

WORKDIR /app

COPY --from=builder --chown=1000:1000 /app ./
RUN install -m 0775 -d /app/logs

ENV NODE_ENV=production

CMD ["node", "./dist/main.js"]
